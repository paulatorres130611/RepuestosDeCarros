<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Compra</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .form-container {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h3, h4 {
            color: #495057;
            font-weight: bold;
        }
        .btn-primary {
            float: right;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div class="row">
        <!-- Parte Izquierda: Formulario -->
        <div class="col-md-6">
            <div class="form-container">
                <h3>Registrar Compra</h3>
                <!-- Barra de búsqueda del proveedor -->
                <div class="input-group mb-3">
                    <input type="text" id="rutProveedor" class="form-control" placeholder="Ingrese el RUT del proveedor">
                    <button class="btn btn-primary" type="button" id="btnAutocompletar">Autocompletar</button>
                </div>
                <!-- Campo para mostrar el nombre del proveedor -->
                <div class="mb-3">
                    <label for="nombreProveedor" class="form-label">Nombre del Proveedor</label>
                    <input type="text" id="nombreProveedor" class="form-control" placeholder="Nombre del proveedor" readonly>
                </div>
                <!-- Fecha de la compra -->
                <div class="mb-3">
                    <label for="fechaCompra" class="form-label">Fecha de Compra</label>
                    <input type="date" id="fechaCompra" class="form-control" th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" readonly>
                </div>

                <!-- Detalles de la compra -->
                <h4>Detalles de la Compra</h4>
                <!-- Búsqueda de Producto -->
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="nombre" class="form-label">Nombre del Producto</label>
                        <input type="text" id="nombre" class="form-control" placeholder="Ingrese el nombre">
                    </div>
                    <div class="col-md-6">
                        <label for="linea" class="form-label">Línea</label>
                        <input type="text" id="linea" class="form-control" placeholder="Ingrese la línea">
                    </div>
                    <div class="col-md-12">
                        <button type="button" class="btn btn-primary" id="btnBuscarProducto">Buscar Producto</button>
                    </div>
                </div>
                <!-- Resultados de la búsqueda -->
                <div class="mt-3">
                    <label for="resultadoProductos" class="form-label">Productos Encontrados</label>
                    <select id="resultadoProductos" class="form-select">
                        <option value="">Seleccione un producto</option>
                        <!-- Productos encontrados se cargarán aquí -->
                    </select>
                </div>

                <!-- Cantidad y Precio de Compra -->
                <div class="row g-3 mt-3">
                    <div class="col-md-6">
                        <label for="cantidad" class="form-label">Cantidad</label>
                        <input type="number" id="cantidad" class="form-control" placeholder="Cantidad" min="1">
                    </div>
                    <div class="col-md-6">
                        <label for="precioCompra" class="form-label">Precio de Compra</label>
                        <input type="number" id="precioCompra" class="form-control" placeholder="Precio de Compra" step="0.01">
                    </div>
                    <div class="col-md-12">
                        <button type="button" class="btn btn-success w-100" id="btnAgregarProducto">Agregar Producto</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Parte Derecha: Tabla de Productos -->
        <div class="col-md-6">
            <div class="form-container">
                <h4>Productos Agregados</h4>
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Línea</th>
                        <th>Cantidad</th>
                        <th>Precio</th>
                        <th>Subtotal</th>
                        <th>Acción</th>
                    </tr>
                    </thead>
                    <tbody id="productosTable">
                    <!-- Los productos se agregarán dinámicamente aquí -->
                    </tbody>
                </table>
                <!-- Total -->
                <div class="mt-3">
                    <label for="totalCompra" class="form-label">Total de la Compra</label>
                    <input type="text" id="totalCompra" class="form-control" placeholder="0.00" readonly>
                </div>
                <!-- Botón Guardar -->
                <button class="btn btn-primary mt-3 w-100" id="btnGuardarCompra">Guardar Compra</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script>
    let productos = [];
    let totalCompra = 0;

    // Buscar productos
    document.getElementById("btnBuscarProducto").addEventListener("click", () => {
        const nombre = document.getElementById("nombre").value;
        const linea = document.getElementById("linea").value;

        if (!nombre || !linea) {
            alert("Por favor, ingrese el nombre y la línea del producto.");
            return;
        }

        fetch(`/productos/buscar?nombre=${nombre}&linea=${linea}`)
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById("resultadoProductos");
                select.innerHTML = '<option value="">Seleccione un producto</option>';
                data.forEach(producto => {
                    const option = document.createElement("option");
                    option.value = producto.id;
                    option.textContent = `${producto.nombre} - ${producto.linea}`;
                    select.appendChild(option);
                });
            });
    });

    // Agregar producto a la tabla
    document.getElementById("btnAgregarProducto").addEventListener("click", () => {
        const productoId = document.getElementById("resultadoProductos").value;
        const cantidad = parseInt(document.getElementById("cantidad").value);
        const precioCompra = parseFloat(document.getElementById("precioCompra").value);

        if (!productoId || !cantidad || !precioCompra) {
            alert("Por favor, complete todos los campos.");
            return;
        }

        // Aquí deberías buscar el producto por ID y usar los datos del inventario
        const producto = {
            id: productoId,
            cantidad: cantidad,
            precioCompra: precioCompra,
            subtotal: cantidad * precioCompra,
        };

        productos.push(producto);
        actualizarTabla();
    });

    function actualizarTabla() {
        const tbody = document.getElementById("productosTable");
        tbody.innerHTML = "";
        productos.forEach((producto, index) => {
            const row = `
                    <tr>
                        <td>${producto.id}</td>
                        <td>${producto.cantidad}</td>
                        <td>${producto.precioCompra.toFixed(2)}</td>
                        <td>${producto.subtotal.toFixed(2)}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="eliminarProducto(${index})">Eliminar</button></td>
                    </tr>
                `;
            tbody.innerHTML += row;
        });

        document.getElementById("totalCompra").value = productos.reduce((total, p) => total + p.subtotal, 0).toFixed(2);
    }

    function eliminarProducto(index) {
        productos.splice(index, 1);
        actualizarTabla();
    }
</script>
</body>
</html>
